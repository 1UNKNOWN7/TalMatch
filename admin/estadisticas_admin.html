<!DOCTYPE html>
<html lang="es">
<head>
  <!-- ===== Meta ===== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>TalMatch – Estadísticas</title>

  <!-- ===== Estilos ===== -->
  <link rel="stylesheet" href="estadisticas_admin.css"/>

  <!-- Fuente coherente -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="page-wrap">
    <!-- ===== Header ===== -->
    <header class="tm-header">
      <div class="brand">
        <img src="/imagenes/talmach.jpg" alt="TalMatch" class="logo">
        <h1>Estadísticas de uso</h1>
      </div>
      <div class="header-actions">
        <a href="inicio_admin.html" class="btn btn-secondary">← Volver</a>
        <!-- Toggle dark mode -->
        <label class="theme-toggle">
          <input id="themeSwitch" type="checkbox" aria-label="Activar modo oscuro">
          <span class="slider"></span>
          <span class="theme-label">Modo oscuro</span>
        </label>
      </div>
    </header>

    <main class="tm-container">
      <!-- Toast -->
      <div id="toast" class="toast" role="status" aria-live="polite"></div>

      <!-- ===== Card: filtros globales ===== -->
      <section class="card card-filtros">
        <div class="toolbar">
          <div class="control">
            <label for="periodo">Periodo</label>
            <select id="periodo">
              <option value="30">Últimos 30 días</option>
              <option value="90">Últimos 90 días</option>
              <option value="365">Últimos 12 meses</option>
              <option value="ALL">Todos</option>
            </select>
          </div>
          <div class="actions">
            <button id="btnDemo" class="btn btn-ghost">Cargar demo</button>
            <button id="btnReset" class="btn btn-ghost">Reiniciar</button>
          </div>
        </div>
      </section>

      <!-- ===== Grid de métricas + charts ===== -->
      <section class="grid">
        <!-- KPI cards -->
        <div class="card kpi">
          <div class="k-title">Usuarios activos</div>
          <div id="kUsuarios" class="k-value">0</div>
          <div class="k-sub muted">promedio diario</div>
        </div>
        <div class="card kpi">
          <div class="k-title">Nuevos registros</div>
          <div id="kRegistros" class="k-value">0</div>
          <div class="k-sub muted">en el periodo</div>
        </div>
        <div class="card kpi">
          <div class="k-title">Matches</div>
          <div id="kMatches" class="k-value">0</div>
          <div class="k-sub muted">generados</div>
        </div>
        <div class="card kpi">
          <div class="k-title">Conversión a contratado</div>
          <div id="kConv" class="k-value">0%</div>
          <div class="k-sub muted">matches → contratado</div>
        </div>

        <!-- Chart 1: Barras (matches por semana) -->
        <div class="card chart">
          <h2>Matches por semana</h2>
          <svg id="chartBarras" viewBox="0 0 400 160" aria-label="Barras de matches por semana"></svg>
        </div>

        <!-- Chart 2: Línea (usuarios activos) -->
        <div class="card chart">
          <h2>Usuarios activos diarios</h2>
          <svg id="chartLinea" viewBox="0 0 400 160" aria-label="Línea de usuarios activos"></svg>
        </div>

        <!-- Chart 3: Dona (distribución por carrera) -->
        <div class="card chart">
          <h2>Distribución por carrera</h2>
          <svg id="chartDona" viewBox="0 0 200 200" aria-label="Distribución por carrera (dona)"></svg>
          <div id="legendDona" class="legend"></div>
        </div>
      </section>
    </main>

    <footer class="tm-footer"><small>© TalMatch · Admin</small></footer>
  </div>

  <!-- ===== JS DEMO (sin librerías externas) ===== -->
  <script>
    // Keys
    const KEY_THEME = "talmatch_theme";
    const KEY_STATS = "talmatch_admin_stats";

    // Refs
    const themeSwitch = document.getElementById('themeSwitch');
    const toast = document.getElementById('toast');
    const periodo = document.getElementById('periodo');
    const btnDemo = document.getElementById('btnDemo');
    const btnReset = document.getElementById('btnReset');

    const kUsuarios = document.getElementById('kUsuarios');
    const kRegistros = document.getElementById('kRegistros');
    const kMatches = document.getElementById('kMatches');
    const kConv = document.getElementById('kConv');

    const chartBarras = document.getElementById('chartBarras');
    const chartLinea = document.getElementById('chartLinea');
    const chartDona = document.getElementById('chartDona');
    const legendDona = document.getElementById('legendDona');

    // Tema
    (function initTheme(){
      const saved = localStorage.getItem(KEY_THEME) || "light";
      if (saved === "dark") { document.body.classList.add("dark"); themeSwitch.checked = true; }
      themeSwitch.addEventListener("change", ()=>{
        document.body.classList.toggle("dark", themeSwitch.checked);
        localStorage.setItem(KEY_THEME, themeSwitch.checked ? "dark" : "light");
      });
    })();

    // Utils
    function toastMsg(msg,type="success"){ toast.textContent = msg; toast.className = `toast ${type} show`; setTimeout(()=>toast.classList.remove('show'),1800); }
    function save(data){ localStorage.setItem(KEY_STATS, JSON.stringify(data)); }
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY_STATS) || "null"); }catch{ return null; } }

    // Demo data (simple y visual)
    function seed(){
      // 8 semanas de matches
      const weeks = [12, 18, 22, 19, 27, 31, 29, 35];
      // 30 días de usuarios activos
      const users = Array.from({length:30}, (_,i)=> 120 + Math.round(30*Math.sin(i/5)) + Math.round(Math.random()*10));
      // Donut por carrera
      const dist = [
        { label:"Sistemas", value:48 },
        { label:"Marketing", value:22 },
        { label:"Administración", value:18 },
        { label:"Diseño", value:12 },
      ];
      return {
        period:"30",
        kpis:{ activos: 152, registros: 64, matches: weeks.reduce((a,b)=>a+b,0), conv: 14 },
        weeks, users, dist
      };
    }

    let stats = load() || seed();

    // Render KPIs
    function renderKPIs(){
      kUsuarios.textContent = stats.kpis.activos;
      kRegistros.textContent = stats.kpis.registros;
      kMatches.textContent = stats.kpis.matches;
      kConv.textContent = stats.kpis.conv + "%";
    }

    // Render Barras (SVG) – no dependencias
    function renderBarras(){
      const w=400, h=160, pad=24;
      const data = stats.weeks;
      const max = Math.max(...data, 1);
      const bw = (w - pad*2) / data.length - 8;
      let svg = `<rect x="0" y="0" width="${w}" height="${h}" fill="none"/>`;
      data.forEach((v,i)=>{
        const x = pad + i*((w-pad*2)/data.length) + 4;
        const bh = (h - pad*2) * (v/max);
        const y = h - pad - bh;
        svg += `<rect x="${x}" y="${y}" width="${bw}" height="${bh}" rx="6" fill="var(--tm-blue)"></rect>`;
      });
      // eje base
      svg += `<line x1="${pad}" y1="${h-pad}" x2="${w-pad}" y2="${h-pad}" stroke="var(--border)"/>`;
      chartBarras.innerHTML = svg;
    }

    // Render Línea (SVG)
    function renderLinea(){
      const w=400, h=160, pad=24;
      const data = stats.users;
      const max = Math.max(...data, 1), min = Math.min(...data, 0);
      const dx = (w - pad*2) / (data.length-1 || 1);
      const scaleY = v => h - pad - ((h - pad*2) * ( (v-min) / (max-min || 1) ));
      let d="";
      data.forEach((v,i)=>{ const x = pad + i*dx; const y = scaleY(v); d += (i? "L":"M") + x + " " + y + " "; });
      let svg = `<rect x="0" y="0" width="${w}" height="${h}" fill="none"/>`;
      svg += `<path d="${d}" fill="none" stroke="var(--tm-blue)" stroke-width="3" />`;
      // eje base
      svg += `<line x1="${pad}" y1="${h-pad}" x2="${w-pad}" y2="${h-pad}" stroke="var(--border)"/>`;
      chartLinea.innerHTML = svg;
    }

    // Render Dona (SVG)
    function renderDona(){
      const data = stats.dist;
      const total = data.reduce((a,b)=> a + b.value, 0);
      const cx=100, cy=100, r=70, r2=45;
      let angle = -Math.PI/2;
      const colors = ["var(--tm-blue)","#22c55e","#f59e0b","#ef4444"];
      let svg = "";
      data.forEach((item, idx)=>{
        const frac = item.value / total;
        const ang2 = angle + frac * Math.PI*2;
        const x1 = cx + r*Math.cos(angle), y1 = cy + r*Math.sin(angle);
        const x2 = cx + r*Math.cos(ang2), y2 = cy + r*Math.sin(ang2);
        const large = frac > 0.5 ? 1 : 0;
        svg += `
          <path d="M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z"
                fill="${colors[idx%colors.length]}"></path>`;
        angle = ang2;
      });
      // agujero central
      svg += `<circle cx="${cx}" cy="${cy}" r="${r2}" fill="var(--card)"></circle>`;
      chartDona.innerHTML = svg;

      // leyenda
      legendDona.innerHTML = data.map((d,i)=>`
        <div class="leg">
          <span class="dot" style="background:${colors[i%colors.length]}"></span>
          <span>${d.label}</span>
          <span class="muted">${Math.round(d.value/total*100)}%</span>
        </div>
      `).join("");
    }

    // Filtros (solo cambian seed en demo; en real llamarías a API)
    periodo.addEventListener("change", ()=>{
      // En demo, solo guardamos la preferencia visual
      stats.period = periodo.value;
      save(stats); renderAll();
    });

    // Demo
    btnDemo.addEventListener("click", ()=>{ stats = seed(); save(stats); renderAll(); toastMsg("Datos de demo cargados"); });
    btnReset.addEventListener("click", ()=>{ localStorage.removeItem(KEY_STATS); stats = seed(); renderAll(); toastMsg("Demo reiniciada"); });

    function renderAll(){ renderKPIs(); renderBarras(); renderLinea(); renderDona(); }
    renderAll();
  </script>
</body>
</html>
